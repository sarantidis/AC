<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>‚ùÑÔ∏è AC_Triage Evaluation Pro v3.9a</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background-color: #f4f4f4;
    }
    h2 {
      color: #0074D9;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, textarea {
      padding: 6px;
      margin-bottom: 10px;
      width: 100%;
    }
    textarea {
      resize: vertical;
    }
    button {
      margin-top: 10px;
      padding: 10px;
      background-color: #0074D9;
      color: white;
      border: none;
      cursor: pointer;
    }
    .result {
      margin-top: 20px;
      background-color: #fff;
      padding: 15px;
      border-radius: 6px;
      font-size: 15px;
      line-height: 1.5;
    }
    .report-section {
      margin-top: 20px;
      padding: 10px;
      border-left: 4px solid #0074D9;
      background-color: #fdfdfd;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .report-section img {
      max-width: 100%;
      height: auto;
      margin-top: 10px;
      page-break-inside: avoid;
    }
    #photoPreview img {
      max-width: 120px;
      border: 1px solid #ccc;
      padding: 4px;
      background: #fff;
    }
    @media print {
      body * { visibility: hidden; }
      #output, #output * { visibility: visible; }
      #output {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
.report-section {
  page-break-inside: avoid;
  break-inside: avoid;
  margin-bottom: 10px;
}

img {
  page-break-inside: avoid;
  break-inside: avoid;
  display: block;
  max-width: 100%;
}
.tech-only {
  display: block;
  font-size: 0.85em;
  color: #888;
}
@media print {
  .tech-only {
    display: none;
  }
}

    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<!-- Branding Modal -->
<div id="brandingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#00000099; z-index:1000; align-items:center; justify-content:center;">
  <div style="background:white; padding:20px; border-radius:8px; max-width:400px; width:100%; text-align:center;">
    <h3>Setup Your Shop Branding</h3>
    <label>Shop Name:</label>
    <input type="text" id="shopNameInput" />
    <label>Upload Logo:</label>
    <input type="file" id="shopLogoInput" accept="image/*" />
    <label>Contact Info (Optional):</label>
    <textarea id="shopContactInput" rows="2" placeholder="Phone, email, or address..."></textarea>
    <br>
    
<button onclick="saveBranding()">Save Branding</button>

  </div>
</div>

<!-- Branding Preview in Report -->
<div id="brandingHeader" style="margin-bottom: 20px; padding: 10px; background: white; border: 1px solid #ccc; border-radius: 5px;"></div>

<button id="changeBrandingBtn" style="float:right; margin-bottom: 10px;">Change Branding</button>

<!-- END Branding Modal -->
<br>
<h2>üîß AC_Triage Evaluation Pro v3.9a </h2>

<div class="description">This report establishes a baseline for evaluating A/C system performance. It supports accurate repair decisions and post-repair validation.
</div>

<div style="display: flex; gap: 20px;">
  <div style="flex: 1;">
    <label>RO#:</label>
    <input type="text" id="ro" />
  </div>
  <div style="flex: 1;">
    <label>Customer:</label>
    <input type="text" id="customer" />
  </div>
  <div style="flex: 2;">
    <label>Vehicle <em>(YMM)</em>:</label>
    <input type="text" id="vehicle" />
  </div>
</div>
<div id="timestamp" style="margin: 10px 0; font-weight: bold;"></div>

<!-- First Row: ZIP, Ambient, RH -->

<div style="display: flex; flex-wrap: nowrap; gap: 10px; margin-bottom: 10px;">
  <div style="flex: 1;">
    <label for="zipCode" style="font-size: 0.9em;">ZIP Code <em>(fetch weather)</em>:</label>
    <input type="text" id="zipCode" maxlength="5" placeholder="e.g. 77001" style="width: 25%;" />
    <small id="weatherStatus" style="color: #0074D9;"></small>
<div> <small>Tech Note: <em>Best Ambient Temp sampling is taken 18" front of condenser</em></small>
</div>  
</div>
  </div>

<div style="display: flex; flex-wrap: nowrap; gap: 10px; align-items: flex-end; margin-bottom: 10px;">
  <!-- Ambient Temp -->
  <div style="width: 20%;">
    <label style="font-size: 0.9em;">Ambient Temp (¬∞F):</label>
    <input type="number" id="ambient" style="width: 90%;" />
  </div>
  <!-- Humidity -->
  <div style="width: 20%;">
    <label style="font-size: 0.9em;">Humidity (%):</label>
    <input type="number" id="rh" min="0" max="100" placeholder="e.g. 45" style="width: 90%;" />
  </div>
  <!-- Refrigerant Type -->
  <div style="width: 22%;">
    <label style="font-size: 0.9em;">Refrigerant Type:</label>
    <select id="refrigerant" style="width: 100%;">
      <option value="r134a">R-134a</option>
      <option value="r1234yf">R-1234yf</option>
    </select>
  </div>
  <!-- Factory Charge -->
  <div style="width: 20%;">
    <label style="font-size: 0.9em;">Factory Charge:</label>
    <input type="number" id="factoryCharge" placeholder="e.g. 20" style="width: 90%;" />
  </div>
  <!-- Charge Unit -->
  <div style="width: 20%;">
    <label style="font-size: 0.9em;">Unit:</label>
    <select id="chargeUnit" style="width: 60%;">
      <option value="oz">oz</option>
      <option value="lb">lb</option>
      <option value="g">g</option>
    </select>
  </div>
</div>


<div style="margin-bottom: 10px; font-size: 0.95em; color: #0074D9;">
  <div id="staticPressureRangeDisplay">
     ‚è≤Ô∏è Expected Static Pressure (Engine Off): <em>ambient temp?</em>
  </div>
  <div style="display: flex; gap: 10px; margin-top: 6px;">
    <div style="width: 200px;">
      <label style="font-size: 0.9em;">Static Pressure (PSI):</label>
      <input type="number" id="staticPressure" placeholder="e.g. 94" style="width: 80%;" />
    </div>
  </div>
</div>

<div class="description"><small>Tech Note: <em>Dynamic Test: Setting on MAX cooling (lowest temp), blower max, condenser fan active, 800~1,500 RPM.</em></small></div>

<div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 10px;">

  <div style="flex: 1;">
    <label style="font-weight: bold; font-size: 0.9em;">Low-Side Pressure (PSI):</label><br>
    <input type="number" id="evapPressure" style="width: 100%;" />
  </div>

  <div style="flex: 1;">
    <label style="font-weight: bold; font-size: 0.9em;">Evaporator Outlet Temp (¬∞F):</label><br>
    <input type="number" id="evapOutlet" style="width: 100%;" />
  </div>

  <div style="flex: 1;">
    <label style="font-weight: bold; font-size: 0.9em;">Evaporator Temp Source:</label><br>
    <select id="evapTempSource" style="width: 100%;">
      <option value="line">At Suction Line</option>
      <option value="sensor">At ETS (Sensor Data)</option>
    </select>
  </div>

</div>

<!-- Low Side Saturation Temp Display below -->
<div id="satTempDisplay" style="font-size: 0.9em; color: #0074D9; margin-bottom: 15px;"></div>

<div style="display: flex; gap: 20px; align-items: flex-end; margin-bottom: 10px;">

  <div style="flex: 1;">
    <label style="font-weight: bold; color: #FF4136; font-size: 0.9em;">High-Side Pressure (PSI):</label><br>
    <input type="number" id="highPressure" style="width: 100%;" />
      </div>
  <div style="flex: 1;">
    <label style="font-weight: bold; font-size: 0.9em;">Condenser Outlet Temp (¬∞F):</label><br>
    <input type="number" id="outlet" style="width: 100%;" />
  </div>

  <div style="flex: 1;">
    <label for="compressorType" style="font-weight: bold; font-size: 0.9em;">Compressor Type:</label><br>
    <select id="compressorType" style="width: 100%;">
      <option value="vdc">VDC (Variable Displacement)</option>
      <option value="fixed">Fixed</option>
      <option value="scroll">Scroll</option>
    </select>
  </div>

</div>
<div id="highSatTempDisplay" style="font-size: 0.9em; color: #FF4136; margin-bottom: 15px;"></div>


<div style="flex: 1;">
    <label>Center Vent Temperature (¬∞F):</label>
    <input type="number" id="vent" />
  </div>

<label for="testStage">Evaluation Type:</label>
<select id="testStage">
  <option value="Pre-Test Evaluation">Pre-Test Evaluation</option>
  <option value="Final Results Evaluation">Final Results Evaluation</option>
</select>
<label>Technician Observations:</label>
<textarea id="techNotes" rows="4" placeholder="Enter any notes, findings, or recommendations..."></textarea>

<label>Attach Photos (Max 5):</label>
<input type="file" id="photos" accept="image/*" multiple capture="environment" />
<div id="photoPreview" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;"></div>

<button id="evaluateBtn">Evaluate</button>
<button onclick="window.print()">üñ®Ô∏è Print Report</button>
<button id="downloadBtn">üìÑ Download PDF</button>

<div class="result" id="output"></div>


<script>
function openBrandingModal() {
  document.getElementById('brandingModal').style.display = 'flex';
}

function saveBranding() {
  const shopName = document.getElementById('shopNameInput').value;
  const contact = document.getElementById('shopContactInput').value;
  const logoInput = document.getElementById('shopLogoInput');
  
  if (!shopName) {
    alert("Please enter a shop name.");
    return;
  }

  const brandingData = { shopName, contact };

  const file = logoInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (e) {
      brandingData.logo = e.target.result;
      localStorage.setItem('shopBranding', JSON.stringify(brandingData));
      document.getElementById('brandingModal').style.display = 'none';
      renderBranding();
    };
    reader.readAsDataURL(file);
  } else {
    const existing = JSON.parse(localStorage.getItem('shopBranding') || '{}');
    brandingData.logo = existing.logo || '';
    localStorage.setItem('shopBranding', JSON.stringify(brandingData));
    document.getElementById('brandingModal').style.display = 'none';
    renderBranding();
  }
}

function renderBranding() {
  const branding = JSON.parse(localStorage.getItem('shopBranding') || '{}');
  const header = document.getElementById('brandingHeader');
  if (!branding.shopName) {
    openBrandingModal();
    return;
  }

  header.innerHTML = `
    ${branding.logo ? `<img src="${branding.logo}" alt="Logo" style="max-height:60px; display:block; margin: 0 auto 10px;" />` : ''}
    <div style="font-size: 1.4em; font-weight: bold;">${branding.shopName}</div>
    ${branding.contact ? `<div style="font-size: 0.9em; color: #555;">${branding.contact}</div>` : ''}
  `;
}

// Auto-run on page load
document.addEventListener('DOMContentLoaded', () => {
  renderBranding();
});

document.addEventListener('DOMContentLoaded', function () {
document.getElementById('zipCode').addEventListener('input', function () {
  const zip = this.value.trim();
  const weatherStatus = document.getElementById('weatherStatus');

  if (zip.length === 5 && /^\d{5}$/.test(zip)) {
    weatherStatus.textContent = 'Fetching weather...';

    fetch(`https://api.openweathermap.org/data/2.5/weather?zip=${zip},us&units=imperial&appid=c1f623f582996a080fa582661efc36b5`)
      .then(res => res.json())
      .then(data => {
        if (data && data.main) {
          const ambientField = document.getElementById('ambient');
          const rhField = document.getElementById('rh');

          // Only fill if empty to allow override
          if (!ambientField.value) ambientField.value = data.main.temp.toFixed(1);
          if (!rhField.value) rhField.value = data.main.humidity;
	  evaluateStaticPressure();
          weatherStatus.textContent =
            `‚úÖ Weather Loaded: ${data.main.temp.toFixed(1)}¬∞F, RH: ${data.main.humidity}% (editable)`;

          // Optional: store for advanced logic
          window.fetchedWeather = {
            ambient: data.main.temp,
            rh: data.main.humidity
          };
        } else {
          weatherStatus.textContent = '‚ö†Ô∏è Invalid ZIP or data unavailable.';
        }
      })
      .catch(() => {
        weatherStatus.textContent = '‚ö†Ô∏è Failed to fetch weather.';
      });
  } else {
    weatherStatus.textContent = '';
  }
});

function getExpectedVentDelta(ambient) {
  if (ambient <= 35) return { min: 1, max: 2 };
  if (ambient <= 40) return { min: 5, max: 7 };
  if (ambient <= 50) return { min: 10, max: 15 };
  if (ambient <= 70) return { min: 15, max: 25 };
  if (ambient <= 80) return { min: 20, max: 30 };
  if (ambient <= 95) return { min: 25, max: 35 };
  return { min: 30, max: 40 };
}

const ptTable = {
    r134a: [{ psi: 6.5, temp: 0 }, { psi: 7.0, temp: 1 }, { psi: 7.5, temp: 2 },
{ psi: 8.0, temp: 3 }, { psi: 8.5, temp: 4 }, { psi: 9.1, temp: 5 },
{ psi: 9.6, temp: 6 }, { psi: 10.2, temp: 7 }, { psi: 10.8, temp: 8 },
{ psi: 11.3, temp: 9 }, { psi: 11.9, temp: 10 }, { psi: 12.5, temp: 11 },
{ psi: 13.1, temp: 12 }, { psi: 13.8, temp: 13 }, { psi: 14.4, temp: 14 },
{ psi: 15.0, temp: 15 }, { psi: 15.7, temp: 16 }, { psi: 16.4, temp: 17 },
{ psi: 17.0, temp: 18 }, { psi: 17.7, temp: 19 }, { psi: 18.4, temp: 20 },
{ psi: 19.1, temp: 21 }, { psi: 19.9, temp: 22 }, { psi: 20.6, temp: 23 },
{ psi: 21.3, temp: 24 }, { psi: 22.1, temp: 25 }, { psi: 22.9, temp: 26 },
{ psi: 23.7, temp: 27 }, { psi: 24.5, temp: 28 }, { psi: 25.3, temp: 29 },
{ psi: 26.1, temp: 30 }, { psi: 26.9, temp: 31 }, { psi: 27.8, temp: 32 },
{ psi: 28.6, temp: 33 }, { psi: 29.5, temp: 34 }, { psi: 30.4, temp: 35 },
{ psi: 31.3, temp: 36 }, { psi: 32.2, temp: 37 }, { psi: 33.1, temp: 38 },
{ psi: 34.1, temp: 39 }, { psi: 35.0, temp: 40 }, { psi: 36.0, temp: 41 },
{ psi: 37.0, temp: 42 }, { psi: 38.0, temp: 43 }, { psi: 39.0, temp: 44 },
{ psi: 40.1, temp: 45 }, { psi: 41.1, temp: 46 }, { psi: 42.2, temp: 47 }, 
{ psi: 43.2, temp: 48 }, { psi: 44.3, temp: 49 }, { psi: 45.4, temp: 50 }, 
{ psi: 46.6, temp: 51 }, { psi: 47.7, temp: 52 }, { psi: 50.0, temp: 54 }, 
{ psi: 51.2, temp: 55 }, { psi: 52.4, temp: 56 }, { psi: 53.6, temp: 57 },
{ psi: 48.9, temp: 53 }, { psi: 54.9, temp: 58 }, { psi: 56.1, temp: 59 }, 
{ psi: 57.4, temp: 60 }, { psi: 58.7, temp: 61 }, { psi: 60.0, temp: 62 }, 
{ psi: 61.3, temp: 63 }, { psi: 62.7, temp: 64 }, { psi: 64.0, temp: 65 },
{ psi: 65.4, temp: 66 }, { psi: 66.8, temp: 67 }, { psi: 68.2, temp: 68 }, 
{ psi: 69.7, temp: 69 }, { psi: 71.1, temp: 70 }, { psi: 72.6, temp: 71 }, 
{ psi: 74.1, temp: 72 }, { psi: 75.6, temp: 73 }, { psi: 77.1, temp: 74 }, 
{ psi: 78.7, temp: 75 }, { psi: 80.2, temp: 76 }, { psi: 81.8, temp: 77 }, 
{ psi: 83.4, temp: 78 }, { psi: 85.0, temp: 79 }, { psi: 86.7, temp: 80 },
{ psi: 88.4, temp: 81 }, { psi: 90.0, temp: 82 }, { psi: 91.8, temp: 83 },
{ psi: 93.5, temp: 84 }, { psi: 95.2, temp: 85 }, { psi: 97.0, temp: 86 }, 
{ psi: 98.8, temp: 87 }, { psi: 100.6, temp: 88 }, { psi: 102.5, temp: 89 },
{ psi: 104.3, temp: 90 }, { psi: 106.2, temp: 91 }, { psi: 108.1, temp: 92 },
{ psi: 110.0, temp: 93 }, { psi: 112.0, temp: 94 }, { psi: 114.0, temp: 95 }, 
{ psi: 115.9, temp: 96 }, { psi: 118.0, temp: 97 }, { psi: 120.0, temp: 98 }, 
{ psi: 122.1, temp: 99 }, { psi: 124.2, temp: 100 }, { psi: 126.3, temp: 101 },
{ psi: 128.4, temp: 102 }, { psi: 130.6, temp: 103 }, { psi: 132.8, temp: 104 }, 
{ psi: 135.0, temp: 105 }, { psi: 137.2, temp: 106 }, { psi: 139.5, temp: 107 }, 
{ psi: 141.7, temp: 108 }, { psi: 144.0, temp: 109 }, { psi: 146.4, temp: 110 }, 
{ psi: 148.7, temp: 111 }, { psi: 151.1, temp: 112 }, { psi: 153.5, temp: 113 },
{ psi: 156.0, temp: 114 }, { psi: 158.4, temp: 115 }, { psi: 160.9, temp: 116 }, 
{ psi: 163.5, temp: 117 }, { psi: 166.0, temp: 118 }, { psi: 168.6, temp: 119 }, 
{ psi: 171.2, temp: 120 }, { psi: 173.8, temp: 121 }, { psi: 176.5, temp: 122 }, 
{ psi: 179.1, temp: 123 }, { psi: 181.8, temp: 124 }, { psi: 184.6, temp: 125 },
{ psi: 187.4, temp: 126 }, { psi: 190.2, temp: 127 }, { psi: 193.0, temp: 128 }, 
{ psi: 195.8, temp: 129 }, { psi: 198.7, temp: 130 }, { psi: 201.6, temp: 131 },
{ psi: 204.6, temp: 132 }, { psi: 207.6, temp: 133 }, { psi: 210.6, temp: 134 }, 
{ psi: 213.6, temp: 135 }, { psi: 216.7, temp: 136 }, { psi: 219.8, temp: 137 },
{ psi: 222.9, temp: 138 }, { psi: 226.0, temp: 139 }, { psi: 229.2, temp: 140 }, 
{ psi: 232.5, temp: 141 }, { psi: 235.7, temp: 142 }, { psi: 239.0, temp: 143 }, 
{ psi: 242.3, temp: 144 }, { psi: 245.7, temp: 145 }, { psi: 249.1, temp: 146 }, 
{ psi: 252.5, temp: 147 }, { psi: 255.9, temp: 148 }, { psi: 259.4, temp: 149 },
{ psi: 262.9, temp: 150 }, { psi: 266.4, temp: 151 }, { psi: 269.9, temp: 152 }, 
{ psi: 273.5, temp: 153 }, { psi: 277.1, temp: 154 }, { psi: 280.7, temp: 155 }, 
{ psi: 284.4, temp: 156 }, { psi: 288.1, temp: 157 }, { psi: 291.8, temp: 158 }, 
{ psi: 295.6, temp: 159 }, { psi: 299.3, temp: 160 }, { psi: 303.1, temp: 161 },
{ psi: 306.9, temp: 162 }, { psi: 310.8, temp: 163 }, { psi: 314.7, temp: 164 }, 
{ psi: 318.6, temp: 165 }, { psi: 322.5, temp: 166 }, { psi: 326.5, temp: 167 }, 
{ psi: 330.5, temp: 168 }, { psi: 334.5, temp: 169 }, { psi: 338.6, temp: 170 }, 
{ psi: 342.6, temp: 171 }, { psi: 346.7, temp: 172 }, { psi: 350.9, temp: 173 },
{ psi: 355.0, temp: 174 }, { psi: 359.2, temp: 175 }, { psi: 363.4, temp: 176 }, 
{ psi: 367.7, temp: 177 }, { psi: 372.0, temp: 178 }, { psi: 376.3, temp: 179 }, 
{ psi: 380.6, temp: 180 }, { psi: 385.0, temp: 181 }, { psi: 389.4, temp: 182 }, 
{ psi: 393.8, temp: 183 }, { psi: 398.3, temp: 184 }, { psi: 400.0, temp: 185 }
],
    r1234yf: [
            { psi: 9, temp: 0 }, { psi: 11, temp: 4 }, { psi: 14, temp: 8 },
            { psi: 16, temp: 12 }, { psi: 19, temp: 16 }, { psi: 20, temp: 18 },
            { psi: 23, temp: 22 }, { psi: 24, temp: 23 }, { psi: 25, temp: 24 },
            { psi: 28, temp: 28 }, { psi: 31, temp: 32 }, { psi: 33, temp: 34 },
            { psi: 35, temp: 36 }, { psi: 37, temp: 38 }, { psi: 38, temp: 40 },
            { psi: 40, temp: 42 }, { psi: 42, temp: 44 }, { psi: 44, temp: 46 },
            { psi: 47, temp: 48 }, { psi: 49, temp: 50 }, { psi: 51, temp: 52 },
            { psi: 53, temp: 54 }, { psi: 56, temp: 56 }, { psi: 58, temp: 58 },
            { psi: 61, temp: 60 }, { psi: 63, temp: 62 }, { psi: 66, temp: 64 },
            { psi: 68, temp: 66 }, { psi: 71, temp: 68 }, { psi: 74, temp: 70 },
            { psi: 77, temp: 72 }, { psi: 80, temp: 74 }, { psi: 83, temp: 76 },
            { psi: 86, temp: 78 }, { psi: 89, temp: 80 }, { psi: 92, temp: 82 },
            { psi: 96, temp: 84 }, { psi: 99, temp: 86 }, { psi: 102, temp: 88 },
            { psi: 106, temp: 90 }, { psi: 110, temp: 92 }, { psi: 113, temp: 94 },
            { psi: 117, temp: 96 }, { psi: 121, temp: 98 }, { psi: 125, temp: 100 },
            { psi: 129, temp: 102 }, { psi: 133, temp: 104 }, { psi: 137, temp: 106 },
            { psi: 142, temp: 108 }, { psi: 146, temp: 110 }, { psi: 150, temp: 112 },
            { psi: 155, temp: 114 }, { psi: 160, temp: 116 }, { psi: 164, temp: 118 },
            { psi: 169, temp: 120 }, { psi: 174, temp: 122 }, { psi: 179, temp: 124 },
            { psi: 184, temp: 126 }, { psi: 190, temp: 128 }, { psi: 195, temp: 130 },
            { psi: 200, temp: 132 }, { psi: 206, temp: 134 }, { psi: 212, temp: 136 },
            { psi: 218, temp: 138 }, { psi: 223, temp: 140 }, { psi: 229, temp: 142 },
            { psi: 236, temp: 144 }, { psi: 242, temp: 146 }, { psi: 248, temp: 148 },
            { psi: 255, temp: 150 }, { psi: 261, temp: 152 }, { psi: 268, temp: 154 },
            { psi: 275, temp: 156 }, { psi: 282, temp: 158 }, { psi: 289, temp: 160 },
            { psi: 296, temp: 162 }, { psi: 304, temp: 164 }, { psi: 311, temp: 166 },
            { psi: 319, temp: 168 }, { psi: 326, temp: 170 }, { psi: 334, temp: 172 },
            { psi: 342, temp: 174 }, { psi: 351, temp: 176 }, { psi: 359, temp: 178 },
            { psi: 368, temp: 180 }, { psi: 376, temp: 182 }, { psi: 385, temp: 184 },
            { psi: 394, temp: 186 }, { psi: 403, temp: 188 }, { psi: 413, temp: 190 }
        ]
  };

  let attachedImages = [];

  function interpolate(table, psi) {
    for (let i = 0; i < table.length - 1; i++) {
      const low = table[i], high = table[i + 1];
      if (psi >= low.psi && psi <= high.psi) {
        return low.temp + ((psi - low.psi) / (high.psi - low.psi)) * (high.temp - low.temp);
      }
    }
    return table[0].temp;
  }

function getStaticPressureRange(ambientTemp, refrigerant) {
  const table = ptTable[refrigerant];
  if (!table || table.length === 0) return { min: NaN, max: NaN, center: NaN };

  let lower = null, upper = null;

  for (let i = 0; i < table.length - 1; i++) {
    const t1 = table[i].temp;
    const t2 = table[i + 1].temp;
    if (ambientTemp >= t1 && ambientTemp <= t2) {
      lower = table[i];
      upper = table[i + 1];
      break;
    }
  }

  if (!lower || !upper) return { min: NaN, max: NaN, center: NaN };

  const ratio = (ambientTemp - lower.temp) / (upper.temp - lower.temp);
  const interpolatedPsi = lower.psi + ratio * (upper.psi - lower.psi);

  return {
    center: interpolatedPsi,
    min: interpolatedPsi - 2,
    max: interpolatedPsi + 2
  };
}

function evaluateStaticPressure() {
  const ambient = parseFloat(document.getElementById('ambient').value);
  const refrigerant = document.getElementById('refrigerant').value;
  const staticPSI = parseFloat(document.getElementById('staticPressure').value);
  const staticDisplay = document.getElementById('staticPressureRangeDisplay');

  if (isNaN(ambient)) {
    staticDisplay.innerHTML = ` ‚è≤Ô∏è Expected Static Pressure (Engine Off): <em>Enter ambient temp!</em>`;
    return;
  }

  const range = getStaticPressureRange(ambient, refrigerant);

  if (isNaN(staticPSI)) {
    staticDisplay.innerHTML = `
       ‚è≤Ô∏è Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
      <strong>${range.min.toFixed(0)} ‚Äì ${range.max.toFixed(0)} psi</strong><br>
      <em>Enter Static Pressure (PSI) to diagnose fill state or contamination.</em>
    `;
    return;
  }

  const status = (
    staticPSI < range.min ? '‚ö†Ô∏è Below Range ‚Äì Possible Undercharge' :
    staticPSI > range.max + 5 ? 'üî¥ Above Range ‚Äì Possible Non-Condensable Gas (Air)' :
    staticPSI > range.max ? '‚ö†Ô∏è Slightly High ‚Äì Monitor Fill or Heat Soak' :
    '‚úÖ Within Range'
  );

  staticDisplay.innerHTML = `
     ‚è≤Ô∏è Expected Static Pressure (Engine Off) for ${refrigerant.toUpperCase()}: 
    <strong>${range.min.toFixed(0)} ‚Äì ${range.max.toFixed(0)} psi ‚Üí Static Pressure Tested: ${staticPSI}psi<br>
<strong>${status}</strong>
  `;
}

function getSaturationTemp(pressure, refrigerant) {
  const table = ptTable[refrigerant];
  if (!table || table.length === 0) return NaN;

  for (let i = 0; i < table.length - 1; i++) {
    const p1 = table[i].psi;
    const p2 = table[i + 1].psi;
    const t1 = table[i].temp;
    const t2 = table[i + 1].temp;

    if (pressure >= p1 && pressure <= p2) {
      const ratio = (pressure - p1) / (p2 - p1);
      return t1 + ratio * (t2 - t1);
    }
  }

  return NaN; // If pressure is out of PT table range
}


function updateSaturationDisplay() {
    const lowPsi = parseFloat(document.getElementById('evapPressure').value);
    const highPsi = parseFloat(document.getElementById('highPressure').value);
    const refrigerant = document.getElementById('refrigerant').value;
    const lowSatDisplay = document.getElementById('satTempDisplay');
    const highSatDisplay = document.getElementById('highSatTempDisplay');

    if (!isNaN(lowPsi)) {
      const temp = interpolate(ptTable[refrigerant], lowPsi);
      lowSatDisplay.textContent = `Low-Side Saturation Temp: ${temp.toFixed(1)} ¬∞F`;
    } else {
      lowSatDisplay.textContent = '';
    }

    if (!isNaN(highPsi)) {
      const temp = interpolate(ptTable[refrigerant], highPsi);
      highSatDisplay.textContent = `High-Side Saturation Temp: ${temp.toFixed(1)} ¬∞F`;
    } else {
      highSatDisplay.textContent = '';
    }
  }

function previewPhotos() {
  const input = document.getElementById('photos');
  const preview = document.getElementById('photoPreview');

  const files = Array.from(input.files).slice(0, 5 - attachedImages.length);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = function(e) {
      if (attachedImages.length < 5) {
        const img = document.createElement('img');
        img.src = e.target.result;
        img.style.maxWidth = '120px';
        img.style.border = '1px solid #ccc';
        img.style.padding = '4px';
        img.style.background = '#fff';
        attachedImages.push(e.target.result);
        preview.appendChild(img);
      }
    };
    reader.readAsDataURL(file);
  });

  // Clear input to allow re-uploading same image
  input.value = "";
}

function generateConfidenceBreakdown(ventDelta, expectedVentRange, superheat, condDelta, fillPercent, isProperlyCharged) {
  return `
    <div class="report-section">
      <strong>üìä Confidence Score Breakdown:</strong><br>
      üå¨Ô∏è Vent ŒîT: ${ventDelta.toFixed(0)}¬∞F ‚Äì ${ventDelta >= expectedVentRange.min && ventDelta <= expectedVentRange.max ? '‚úÖ Within expected range' : `‚ùå Expected ${expectedVentRange.min}‚Äì${expectedVentRange.max}¬∞F`}<br>
      ‚ùÑÔ∏è Superheat: ${superheat.toFixed(0)}¬∞F ‚Äì ${superheat >= 10 && superheat <= 15 ? '‚úÖ Optimal' : '‚ùå Outside optimal range (10‚Äì15¬∞F)' }<br>
      üî• Condenser ŒîT: ${condDelta.toFixed(0)}¬∞F ‚Äì ${condDelta >= 25 ? '‚úÖ Acceptable' : '‚ùå Low (Target: ‚â•25¬∞F)' }<br>
      üß™ Fill %: ${fillPercent}% ‚Äì ${fillPercent >= 98 && fillPercent <= 102 ? '‚úÖ Ideal' : '‚ùå Deviation from ideal fill'}<br>
      üîç Diagnosis: ${isProperlyCharged ? '‚úÖ Properly Charged' : '‚ùå Not confirmed ‚ÄúProperly Charged‚Äù'}
    </div>
  `;
}


function evaluateEvapTempDifferential(satTemp, evapTemp, source, rh) {
  const diff = evapTemp - satTemp;
  let result = "";
  let tag = "";
  let scoreImpact = 0;
  let rhNote = "";

  if (source === "sensor") {
    if (diff >= 5 && diff <= 10) {
      result = "‚úÖ ETS Differential Normal";
      tag = "CODE-ETS-RANGE-OK-11";
      scoreImpact = 1;
    } else if (diff < 5) {
      result = "‚ö†Ô∏è ETS Too Close to Saturation ‚Äì Freeze Risk";
      tag = "CODE-ETS-RANGE-LOW-12";
      scoreImpact = rh > 70 ? 0 : -1;
      if (rh > 70) rhNote = "Note: High humidity detected. Freeze margin adjusted.";
    } else if (diff > 15) {
      result = "‚ö†Ô∏è ETS Too High ‚Äì Check Mounting";
      tag = "CODE-ETS-RANGE-HIGH-13";
      scoreImpact = -1;
    } else {
      result = "‚ö†Ô∏è Unusual ETS Differential ‚Äì Confirm Sensor Accuracy";
      tag = "CODE-ETS-RANGE-UNKNOWN-17";
      scoreImpact = 0;
    }
  }

  if (source === "line") {
    if (diff >= 8 && diff <= 15) {
      result = "‚úÖ Suction Line Temp Normal";
      tag = "CODE-SUCTION-RANGE-OK-14";
      scoreImpact = 1;
    } else if (diff < 8) {
      result = "‚ö†Ô∏è Outlet Temp Too Cold ‚Äì Flooding?";
      tag = "CODE-SUCTION-RANGE-LOW-15";
      scoreImpact = rh > 70 ? 0 : -1;
      if (rh > 70) rhNote = "Note: High humidity detected. Low outlet temp allowed due to latent load.";
    } else if (diff > 18) {
      result = "‚ö†Ô∏è Outlet Temp Too Warm ‚Äì Poor Load Transfer";
      tag = "CODE-SUCTION-RANGE-HIGH-16";
      scoreImpact = -1;
    } else {
      result = "‚ö†Ô∏è Unusual Outlet Temp Differential ‚Äì Confirm Probe Accuracy";
      tag = "CODE-SUCTION-RANGE-UNKNOWN-17";
      scoreImpact = 0;
    }
  }

  return {
    result: result,
    tag: tag,
    scoreImpact: scoreImpact,
    rhNote: rhNote
  };
}

function runEvaluation() {
  let resultHTML = '';
  let diagnosticTags = [];
  let confidenceScore = 0;
  const refrigerant = document.getElementById('refrigerant').value;
  const ambient = parseFloat(document.getElementById('ambient').value);
  const vent = parseFloat(document.getElementById('vent').value);
  const evapPressure = parseFloat(document.getElementById('evapPressure').value);
  const highPressure = parseFloat(document.getElementById('highPressure').value);
  const evapOutlet = parseFloat(document.getElementById('evapOutlet').value);
  const condOutlet = parseFloat(document.getElementById('outlet').value);
  const factoryCharge = parseFloat(document.getElementById('factoryCharge').value);
  const unit = document.getElementById('chargeUnit').value;
  const techNotes = document.getElementById('techNotes').value;
  const testStage = document.getElementById('testStage').value;
  const evapTemp = parseFloat(document.getElementById("evapOutlet").value);
  const evapTempSource = document.getElementById("evapTempSource").value;
  const rh = parseFloat(document.getElementById("rh").value || 0); // assuming an RH input exists
  const satTemp = getSaturationTemp(evapPressure, refrigerant);
  const evapResult = evaluateEvapTempDifferential(satTemp, evapOutlet, evapTempSource, rh);
  const compressorType = document.getElementById("compressorType").value;
  const staticPSI = parseFloat(document.getElementById('staticPressure').value);
  const staticRange = getStaticPressureRange(ambient, refrigerant);
  const staticMin = staticRange.min.toFixed(0);
  const staticMax = staticRange.max.toFixed(0);

let staticStatus = '';
if (isNaN(staticPSI)) {
  staticStatus = '‚ö†Ô∏è No static pressure measured.';
} else if (staticPSI < staticRange.min) {
  staticStatus = '‚ö†Ô∏è Below Range ‚Äì Possible Undercharge';
} else if (staticPSI > staticRange.max + 5) {
  staticStatus = 'üî¥ Above Range ‚Äì Possible Non-Condensable Gas (Air)';
} else if (staticPSI > staticRange.max) {
  staticStatus = '‚ö†Ô∏è Slightly High ‚Äì Monitor Fill or Heat Soak';
} else {
  staticStatus = '‚úÖ Within Range';
}


resultHTML += `<h3>üå°Ô∏è Evaporator Temp Differential Check</h3>`;
resultHTML += `<p>${evapResult.result}</p>`;
if (evapResult.rhNote) {
  resultHTML += `<p style="color: gray; font-style: italic;">${evapResult.rhNote}</p>`;
}
diagnosticTags.push(evapResult.tag);
confidenceScore += evapResult.scoreImpact; 


 if ([ambient, vent, evapPressure, highPressure, evapOutlet, condOutlet].some(isNaN)) {
    alert('Please complete all pressure/temperature fields.');
    return;
  }

  if (ambient < 50) {
    alert("‚ö†Ô∏è Ambient temperature is below 50¬∞F ‚Äì results may not reflect normal operation.");
  }

  let factoryOz = factoryCharge;
  if (unit === 'lb') factoryOz *= 16;
  else if (unit === 'g') factoryOz /= 28.3495;

  const evapSat = interpolate(ptTable[refrigerant], evapPressure);
  const condSat = interpolate(ptTable[refrigerant], highPressure);
  const superheat = evapOutlet - evapSat;
  const condDelta = condSat - condOutlet;
  const ventDelta = ambient - vent;
  const expectedCondSat = ambient + 25;
  const percentFillRaw = condSat / expectedCondSat;
  const fillPercent = Math.round(percentFillRaw * 100);
  const ozOffset = (1 - percentFillRaw) * factoryOz;
  const grams = ozOffset * 28.3495;
  const pounds = ozOffset / 16;

  // Calculate Compression Ratio
  let compressionRatio = null;
  if (evapPressure > 0) {
     compressionRatio = highPressure / evapPressure;
}

// üî∫ Define Dynamic compressor type Threshold Based on Ambient Temperature
const highRatioThreshold = compressorType === 'vdc'
  ? (ambient >= 100 ? 5.2 : ambient >= 90 ? 4.8 : 4.5)
  : (ambient >= 100 ? 5.0 : ambient >= 90 ? 4.5 : 4.0);


  const fillBar = `
    <div style="margin: 10px 0;">
      <div style="display: flex; justify-content: center;">
        <div style="width: 80%; max-width: 500px; background: #eee; height: 14px; border-radius: 5px; border: 1px solid #ccc; display: flex; overflow: hidden;">
          <div style="width: ${Math.min(fillPercent, 100)}%; background: #2ECC40;"></div>
          ${fillPercent < 100 ? `<div style="width: ${100 - fillPercent}%; background: #ffffff;"></div>` : ''}
          ${fillPercent > 100 ? `<div style="width: ${Math.min(fillPercent - 100, 25)}%; background: #FF4136;"></div>` : ''}
        </div>
      </div>
      <div style="text-align: center; font-size: 0.9em; margin-top: 4px;">
        <strong>Estimated Fill:</strong> ${fillPercent}% ‚Äì ${
          fillPercent < 98 ? '‚ö™ Undercharged' :
          fillPercent > 102 ? 'üî¥ Overcharged' :
          '‚úÖ Properly Charged'
        }
      </div>
    </div>
  `;

const compressionRatioSection = `
  <div class="report-section">
    <strong>üìà Compression Ratio Estimate:</strong><br>
    Discharge: ${highPressure.toFixed(1)} psi / Suction: ${evapPressure.toFixed(1)} psi<br>
    Ratio: ${
      compressionRatio !== null
        ? `${compressionRatio.toFixed(2)}:1<br>` +
          (
            compressionRatio > highRatioThreshold
              ? `üî¥ Above ${highRatioThreshold.toFixed(1)}:1 threshold ‚Äì possible restriction or overcharge.` +
                (compressorType === 'vdc'
                  ? `<br>‚ö†Ô∏è VDC Detected ‚Äì Verify solenoid control, stroke response, or partial loading.` : '')
              : compressionRatio < 2.5
                ? `üü† Below 2.5:1 ‚Äì possible weak or under-commanded compressor.` +
                  (compressorType === 'vdc'
                    ? `<br>‚ö†Ô∏è VDC Detected ‚Äì Test solenoid duty cycle or attempt override.` : '')
                : `‚úÖ Within expected range for current ambient conditions.`
          )
        : 'N/A ‚Äì ‚ö†Ô∏è Unable to calculate'
    }
  </div>
`;

  let chargeStatus = '';
  if (factoryOz > 0 && !isNaN(factoryOz)) {
    chargeStatus = Math.abs(ozOffset) > 0.25
      ? (ozOffset > 0
        ? `‚ö†Ô∏è Undercharged by ~${ozOffset.toFixed(1)} oz (${pounds.toFixed(2)} lb / ${grams.toFixed(0)} g)`
        : `‚ö†Ô∏è Overcharged by ~${Math.abs(ozOffset).toFixed(1)} oz (${Math.abs(pounds).toFixed(2)} lb / ${Math.abs(grams).toFixed(0)} g)`)
      : '';
  } else {
    chargeStatus = `<small style="color:#888;">‚ö†Ô∏è No factory charge value provided ‚Äî weight offset not calculated.</small>`;
  }

// Diagnosis Logic
let diagnosis = '';

if (
  superheat > 25 &&
  evapPressure < 30 &&
  ventDelta < 5 &&
  fillPercent >= 98 && fillPercent <= 105
) {
  diagnosis = `‚ö†Ô∏è Charge appears full based on pressure-temperature estimate, but high superheat, low suction pressure, and warm vent temps indicate an undercharged system (phase starvation).<br><span class="tech-only"><em>Diagnostic Tag: CODE-FILL-LOW-01</em></span>`;
}

if (!diagnosis) {
  if (superheat > 18 && highPressure < 150 && evapPressure < 30) {
    diagnosis = `‚ö†Ô∏è High superheat & low pressure ‚Üí likely undercharged. Est. short: ${ozOffset.toFixed(1)} oz<br><span class="tech-only"><em>Diagnostic Tag: CODE-FILL-LOW-01</em></span>`;
  
  } else if (superheat > 18 && highPressure >= 150 && condDelta >= 25) {
    diagnosis = `‚ö†Ô∏è High superheat + normal condenser performance ‚Üí metering device or flow issue.<br><span class="tech-only"><em>Diagnostic Tag: CODE-METER-01</em></span>`;

  } else if (
    fillPercent > 125 &&
    superheat >= 1 && superheat <= 16 &&
    condDelta >= 18 && condDelta < 25
  ) {
    diagnosis = `‚ö†Ô∏è System is overcharged but currently delivering acceptable cooling. Overfill may reduce long-term evaporator efficiency.<br><span class="tech-only"><em>Diagnostic Tag: CODE-OVERCHARGE-FUNCTIONAL</em></span>`;

  } else if (superheat < 5 && fillPercent > 125) {
    diagnosis = `‚ö†Ô∏è Low superheat & high fill ‚Üí Possible overcharge with excessive oil ratio or poor evaporator heat exchange.<br><span class="tech-only"><em>Diagnostic Tag: CODE-OVERCHARGE-FUNCTIONAL</em></span>`;

  } else if (
    fillPercent > 115 &&
    superheat < 7 &&
    condDelta < 25
  ) {
    diagnosis = `‚ö†Ô∏è Excessive charge + poor heat transfer ‚Üí possible oil overcharge insulating evaporator or condenser surfaces.<br><span class="tech-only"><em>Diagnostic Tag: CODE-OIL-IMBALANCE-01</em></span>`;

  } else if (
    fillPercent > 102 && fillPercent <= 115 &&
    superheat >= 10 && superheat <= 15 &&
    condDelta >= 25
  ) {
    diagnosis = `‚ö†Ô∏è Slight overcharge with balanced performance ‚Äì monitor long-term evap behavior. Consider recovery to OE spec.<br><span class="tech-only"><em>Diagnostic Tag: CODE-OVERCHARGE-MILD-02</em></span>`;

  } else if (
    condDelta > 40 &&
    superheat < 10
  ) {
    diagnosis = `‚ö†Ô∏è High condenser ŒîT and low superheat ‚Üí possible TXV restriction, refrigerant stacking, or overcooling from oil/refrigerant overcharge.<br><span class="tech-only"><em>Diagnostic Tag: CODE-COND-OVERDELTA-01</em></span>`;

  } else if (
    superheat < 8 &&
    condDelta < 25 &&
    fillPercent >= 90 && fillPercent <= 96 &&
    highPressure < 130
  ) {
    diagnosis = `‚ö†Ô∏è Low ŒîT, low SH, and borderline fill ‚Üí suspect weak or underperforming compressor. If system uses a variable displacement compressor, verify control solenoid duty or command state before testing compression ratio.<br><span class="tech-only"><em>Diagnostic Tag: CODE-COMP-RATIO-04</em></span>`;

  } else if (superheat < 5 && evapPressure < 25) {
    diagnosis = `‚ö†Ô∏è Low superheat & low evap pressure ‚Üí sensor error, restriction, or bypassing refrigerant internally.<br><span class="tech-only"><em>Diagnostic Tag: CODE-SENSOR-04</em></span>`;

  } else if (
    percentFillRaw >= 0.95 && (superheat > 18 || condDelta < 20)
  ) {
    diagnosis = `‚ö†Ô∏è Charge appears full, but poor performance ‚Üí check airflow, condenser fan, internal restriction, or blend door.<br><span class="tech-only"><em>Diagnostic Tag: CODE-AIRFLOW-02</em></span>`;

  } else if (
    typeof compressionRatio === 'number' && compressionRatio > 4.5
  ) {
    diagnosis = `‚ö†Ô∏è High compression ratio (${compressionRatio.toFixed(1)}:1) within expected range for high ambient temp. However, elevated ratio may still indicate early restriction or TXV sensitivity. Monitor behavior if ambient cools.<br><span class="tech-only"><em>Diagnostic Tag: CODE-COMP-RATIO-HIGH-06</em></span>`;

  } else if (
    typeof compressionRatio === 'number' && compressionRatio < 2.5
  ) {
    diagnosis = `‚ö†Ô∏è Low compression ratio (${compressionRatio.toFixed(2)}:1) ‚Äì possible weak compressor or under-command. If VDC, check solenoid control.<br><span class="tech-only"><em>Diagnostic Tag: CODE-COMP-RATIO-LOW-05</em></span>`;

  } else if (
    percentFillRaw >= 0.95 && percentFillRaw <= 1.05 &&
    superheat >= 10 && superheat <= 15 &&
    condDelta >= 25
  ) {
    diagnosis = `‚úÖ System appears properly charged.<br><span class="tech-only"><em>Diagnostic Tag: CODE-CHARGE-OK</em></span>`;

  } else {
    diagnosis = `‚ö†Ô∏è System Behavior Unbalanced ‚Äî further diagnostics recommended.<br><span class="tech-only"><em>Diagnostic Tag: CODE-RETEST-99</em></span>`;
  }
}

  const isProperlyCharged =
       percentFillRaw >= 0.95 && percentFillRaw <= 1.05 &&
       superheat >= 10 && superheat <= 15 &&
       condDelta >= 25 &&
      !(diagnosis.includes('CODE-FILL-LOW-01') ||
       (diagnosis.includes('CODE-OVERCHARGE-MILD-02') && percentFillRaw <= 1.05) ||
       (diagnosis.includes('CODE-COMP-RATIO-HIGH-06') && ambient < 95));


// Technician Tip
let techTip = '';

if (diagnosis.includes('CODE-FILL-LOW-01')) {
  techTip = `Start with refrigerant weight verification. Inspect for leaks using UV dye or electronic detector. Recharge and validate superheat.`;

} else if (diagnosis.includes('CODE-METER-01')) {
  techTip = `Check TXV or orifice tube for blockage. Verify expansion with temp drop across valve. Review subcooling and high-side pressure.`;

} else if (diagnosis.includes('CODE-OVERCHARGE-FUNCTIONAL')) {
  techTip = `System cooling is functional, but overfilled. Recover and weigh contents. Recharge to OE spec. Monitor long-term evaporator performance.`;

} else if (diagnosis.includes('CODE-OIL-IMBALANCE-01')) {
  techTip = `Recover & weigh refrigerant and oil. Flush system. Recharge with correct oil type and quantity. Excess oil reduces heat transfer.`;

} else if (diagnosis.includes('CODE-OVERCHARGE-MILD-02')) {
  techTip = `Performance stable, but refrigerant exceeds OE spec. Recommend recovering to specification to protect long-term component life.`;

} else if (diagnosis.includes('CODE-COND-OVERDELTA-01')) {
  techTip = `High condenser ŒîT (>40¬∞F) may indicate restriction or refrigerant stacking. Check subcooling, airflow, and TXV flow behavior.`;

} else if (diagnosis.includes('CODE-COMP-RATIO-04')) {
  techTip = `Suspect weak or low-efficiency compressor. For VDC, unplug or override solenoid. For fixed units, compare suction/discharge delta.`;

} else if (diagnosis.includes('CODE-COMP-RATIO-LOW-05')) {
  techTip = `Low ratio suggests compression loss. Inspect for suction line collapse, internal wear, or undercommanded stroke. Check control solenoid duty.`;

} else if (diagnosis.includes('CODE-COMP-RATIO-HIGH-06')) {
  techTip = `Compression ratio exceeds 4.5:1 ‚Äì acceptable at or above 100¬∞F ambient. Confirm fill % and inspect TXV or orifice if symptoms persist. Monitor subcooling and pressure trends as ambient temperatures drop.`;

} else if (diagnosis.includes('CODE-SENSOR-04')) {
  techTip = `Compare evap temp sensor vs pressure-derived saturation temp. Perform sensor A/B swap if available. Check for open/shorted readings.`;

} else if (diagnosis.includes('CODE-AIRFLOW-02')) {
  techTip = `Inspect condenser fans, airflow path, and blend doors. Blocked airflow or improper mixing can mimic low fill or poor cooling.`;

} else if (diagnosis.includes('CODE-CHARGE-OK')) {
  techTip = `System operating within expected parameters. Perform visual checks to confirm no intermittent or control-based concerns remain.`;

} else if (diagnosis.includes('CODE-RETEST-99')) {
  techTip = `Recheck triage: validate pressures, fill, airflow, and control command state. Review blend door behavior and condenser fan status.`;
}


  // Confidence Score
  const expectedVentRange = getExpectedVentDelta(ambient);
  let score = 0;
  if (ventDelta >= expectedVentRange.min && ventDelta <= expectedVentRange.max) score++;
  if (superheat >= 10 && superheat <= 15) score++;
  if (condDelta >= 25) score++;
  if (percentFillRaw >= 0.98 && percentFillRaw <= 1.02) score++;
  if (isProperlyCharged) score++;

  if (diagnosis.includes('CODE-FILL-LOW-01') && ventDelta < 10 && superheat > 25) {
    score = 0;
  }

  let confidenceLabel = '';
  let confidenceEmoji = '';
  if (
    superheat > 25 || condDelta < 10 ||
    (condDelta > 40 && superheat < 10) || fillPercent > 125
  ) {
    score = 0;
    confidenceLabel = 'Critical Fault ‚Äì Immediate Review';
    confidenceEmoji = 'üö´';
  } else if (score === 5) {
    confidenceLabel = 'Excellent Confidence';
    confidenceEmoji = '‚úÖ';
  } else if (score === 4) {
    confidenceLabel = 'Good Confidence';
    confidenceEmoji = 'üëç';
  } else if (score === 3) {
    confidenceLabel = 'Moderate ‚Äì Needs Review';
    confidenceEmoji = '‚ö†Ô∏è';
  } else {
    confidenceLabel = 'Low ‚Äì Further Testing Advised';
    confidenceEmoji = '‚ùå';
  }

  const customer = document.getElementById('customer').value;
  const vehicle = document.getElementById('vehicle').value;
  const ro = document.getElementById('ro').value;
  const timestamp = new Date().toLocaleString();
  document.getElementById('timestamp').innerText = `Testing Timestamp: ${timestamp}`;
  const brandingContent = document.getElementById('brandingHeader').innerHTML;

  let photoSection = '';
  if (attachedImages.length) {
    photoSection = `
      <div class="report-section">
        <strong>Photos:</strong><br>
        ${attachedImages.map(src => `<img src="${src}" style="max-width: 180px; margin: 5px; border: 1px solid #ccc;">`).join('')}
      </div>
    `;
  }

  document.getElementById('output').innerHTML = `
    <div style="text-align:center; margin-bottom: 20px;">
      ${brandingContent}
    </div>
         <h3 style="text-align: center; margin-bottom: 10px;">üìÑ A/C System Performance Report</h3>    
         <h3 style="text-align: center; margin-bottom: 10px;"> ${testStage}</h3>
             
    <strong>Prepared for: ${customer || 'N/A'}</strong><br>
    Vehicle: ${vehicle || 'N/A'}<br>
    RO#: ${ro || 'N/A'}<br>
    Time: ${timestamp}<br><br>
    Relative Humidity: ${isNaN(rh) ? 'N/A' : rh + '%'}<br><br>

<div class="report-section">
  <strong> ‚è≤Ô∏è Static Pressure Test (Engine Off):</strong><br>
  Ambient Temp: ${ambient}¬∞F<br>
  Expected Range: ${staticMin} ‚Äì ${staticMax} psi<br>
  Measured Static Pressure: ${isNaN(staticPSI) ? 'N/A' : staticPSI + ' psi'}<br>
  Status: ${staticStatus}
</div>

<div class="report-section">
      <strong>üå¨Ô∏è Vent Temp Performance:</strong><br>
      Ambient: ${ambient}¬∞F<br>
      Vent: ${vent}¬∞F ‚Üí ŒîT: ${ventDelta.toFixed(0)}¬∞F
    </div>

    <div class="report-section">
  <strong>‚ùÑÔ∏èEvaporator Superheat Performance:</strong><br>
  PSI: ${evapPressure}, Sat: ${evapSat.toFixed(0)}¬∞F<br>
  Outlet: ${evapOutlet}¬∞F ‚Üí Superheat: ${superheat.toFixed(0)}¬∞F<br>
  ${evapResult.result}<br>
  ${evapResult.rhNote ? `<span style="color: gray; font-style: italic;">${evapResult.rhNote}</span>` : ''}
</div>


    <div class="report-section">
      <strong>üî•Condenser Performance Delta:</strong><br>
      PSI: ${highPressure}, Sat: ${condSat.toFixed(0)}¬∞F<br>
      Outlet: ${condOutlet}¬∞F ‚Üí ŒîT: ${condDelta.toFixed(0)}¬∞F
    </div>

    ${compressionRatioSection}

<div class="report-section">
  <strong>üß™ Refrigerant Charge Estimation:</strong><br>
  Actual Condenser Saturation Temp: ${condSat.toFixed(1)}¬∞F<br>
  Desired Condenser Saturation Temp: ${expectedCondSat.toFixed(1)}¬∞F<br>
  Factory Charge: ${factoryCharge} ${unit}<br>
  ${fillBar}
  ${chargeStatus}
</div>

    <div class="report-section">
      <strong>Diagnosis:</strong><br>
      ${diagnosis}
    </div>

    <div class="report-section tech-only">
      <strong>üß∞ Suggested Test-Plan:</strong><br>
      ${techTip}
    </div>

    <div class="report-section">
      <strong>Confidence Score:</strong><br>
      Score: ${score}/5<br>
      <strong>${confidenceEmoji} ${confidenceLabel}</strong>
    </div>

<div class="report-section">
  <strong>üìä Confidence Score Breakdown:</strong><br>
  üå¨Ô∏è Vent ŒîT: ${ventDelta.toFixed(0)}¬∞F ‚Äì ${ventDelta >= expectedVentRange.min && ventDelta <= expectedVentRange.max ? '‚úÖ Within expected range' : `‚ùå Expected ${expectedVentRange.min}‚Äì${expectedVentRange.max}¬∞F`}<br>
  ‚ùÑÔ∏è Superheat: ${superheat.toFixed(0)}¬∞F ‚Äì ${superheat >= 10 && superheat <= 15 ? '‚úÖ Optimal' : '‚ùå Outside optimal range (10‚Äì15¬∞F)' }<br>
  üî• Condenser ŒîT: ${condDelta.toFixed(1)}¬∞F ‚Äì ${condDelta >= 25 ? '‚úÖ Acceptable' : '‚ùå Low (Target: ‚â•25¬∞F)' }<br>
  üß™ Fill %: ${fillPercent}% ‚Äì ${percentFillRaw >= 0.95 && percentFillRaw <= 1.05 ? '‚úÖ Ideal' : '‚ùå Deviation from ideal fill'}<br>
  üîç Charge Status: ${isProperlyCharged ? '‚úÖ Acceptable - *Exceptions: Overall Behavior Overrides Pressure to Temp Range.' : '‚ùå ‚ÄúProperly Charged‚Äù Not confirmed'}
</div>


    ${techNotes ? `<div class="report-section"><strong>Technician Notes:</strong><br>${techNotes.replace(/\n/g, '<br>')}</div>` : ''}
    ${photoSection}
  `;
}

function downloadPDF() {
  const reportEl = document.getElementById('output');
  if (!reportEl) return;

  const images = reportEl.querySelectorAll('img');
  const promises = Array.from(images).map(img => {
    if (img.complete) return Promise.resolve();
    return new Promise(resolve => {
      img.onload = img.onerror = resolve;
    });
  });

  Promise.all(promises).then(() => {
    const opt = {
      margin: 0.4,
      filename: 'AC-Triage-Report.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        scrollY: 0
      },
      jsPDF: {
        unit: 'in',
        format: 'letter',
        orientation: 'portrait'
      },
      pagebreak: {
        mode: ['css', 'legacy'],
        avoid: ['.report-section', 'img', '.photo-group']
      }
    };

    html2pdf().set(opt).from(reportEl).save();
  });
}

document.getElementById('changeBrandingBtn').addEventListener('click', openBrandingModal);
document.getElementById('ambient').addEventListener('input', evaluateStaticPressure);
document.getElementById('refrigerant').addEventListener('change', evaluateStaticPressure);
document.getElementById('staticPressure').addEventListener('input', evaluateStaticPressure);
document.getElementById('evaluateBtn').addEventListener('click', runEvaluation);
document.getElementById('downloadBtn').addEventListener('click', downloadPDF);
  document.getElementById('photos').addEventListener('change', previewPhotos);
  document.getElementById('evapPressure').addEventListener('input', updateSaturationDisplay);
  document.getElementById('highPressure').addEventListener('input', updateSaturationDisplay);
  document.getElementById('refrigerant').addEventListener('change', evaluateStaticPressure);


  // Initial Branding Render
  renderBranding();
});
</script>
<footer style="text-align: center; margin-top: 40px; font-size: 0.85em; color: #666;">
  ¬© 2025 A/C System Triage | Peter Sarantidis - Developer - ASE Master Tech - Advanced SME
</footer>
</body>

</html>
